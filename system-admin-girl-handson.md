# シス管系女子 ハンズオン

subtitle
:   試して覚えよう！ SSHポートフォワーディング

author
:   Piro / 結城洋志

institution
:   株式会社クリアコード

allotted_time
:   60m




# 使用するサーバーを準備しよう

踏み台になるサーバーと
社内専用Webサーバーを用意しよう

# 目指すゴール

（ネットワーク構成図）

# ローカルネットワークの作成

（スクリーンショット）

# 鍵ペアの作成

（スクリーンショット）

# VPSの作成（踏み台）

（スクリーンショット）

 * 既定の設定

# VPSの作成（社内専用サーバー）

（スクリーンショット）

 * CentOS + nginx + wordpress

# VPSの設定（踏み台）

（スクリーンショット）

 * ローカルネットワークに接続
 * セットアップ用スクリプトを実行

# VPSの設定（社内専用サーバー）

（スクリーンショット）

 * ローカルネットワークに接続
 * セットアップ用スクリプトを実行

# 動作を確かめてみよう

（スクリーンショット）

 * WordPressの初期画面が表示されるか？

# 社内専用サーバーをインターネットから切り離そう

 * 設定変更用スクリプトを実行

# 準備完了

（ネットワーク構成図）




# SSHポートフォワーディングを試してみよう

# ポートフォワーディングとは？

（概念図）



# Case0; 社外にあるPCから社内専用のサーバーにSSH接続したい

（ネットワーク構成図）

これは、ポートフォワーディングが必要ないケース。

手元のPC：

~~~
$ ssh root@203.0.113.1 -i .ssh/conoha
~~~

ログイン先の踏み台サーバー（front）：

~~~
$ ssh root@192.168.0.110 -i .ssh/conoha
~~~

（概念図）



# Case1: ローカルフォワード（順方向のポートフォワード）

（概念図）


# Case1-1: 社外にあるPCから社内専用のサーバーにSCPでファイルをアップロードしたい（または、ファイルをダウンロードしたい）

（ネットワーク構成図）

手元のPC：

~~~
$ ssh root@203.0.113.1 -i .ssh/conoha -L 10022:192.168.0.110:22
$ scp -P 10022 ~/myfile.zip root@localhost:/path/to/destination/directory/
$ scp -P 10022 root@localhost:/path/to/file ~/
~~~

（概念図）



# Case1-2: 社外にあるPCから社内専用のサーバーにHTTP接続したい

（ネットワーク構成図）

社外から、社内にあるRedmineなどにアクセスする、というような場面。

手元のPC：

~~~
$ ssh root@203.0.113.1 -i .ssh/conoha -L 10080:192.168.0.110:80
~~~

手元のPCの別のコンソール：

~~~
$ curl -L "http://localhost:10080/"
~~~

（概念図）



# Case1-2': 社外にある他のPCからも社内専用のサーバーにHTTP接続したい

（ネットワーク構成図）

手元のPC：

~~~
$ ssh root@203.0.113.1 -i .ssh/conoha -L 10080:192.168.0.110:80 -g
~~~

同一セグメント内にある他のPC：

~~~
$ curl -L "http://192.168.1.10:10080/wp-admin/install.php"
~~~

（概念図）




# Case2: リモートフォワード（逆方向のポートフォワード）

（概念図）


# Case2-1: 社内のコンピューターから社外にあるPCにSSHでログインしたい

（ネットワーク構成図）

手元のPCの調子がおかしいので、社内にいる大野先輩に遠隔操作でトラブルシューティングしてもらう、というような場面。
手元のPCにはguestというユーザーを作成済みとする。

手元のPC：

~~~
$ ssh root@203.0.113.1 -i .ssh/conoha  -R 20022:localhost:22
~~~

社内にあるコンピューター（back）

~~~
ohno@back$ ssh ohno@192.168.0.100
ohno@front$ ssh guest@localhost -p 20022
~~~

（概念図）

別解

~~~
$ ssh root@203.0.113.1 -i .ssh/conoha  -R 192.168.0.100:20022:localhost:22
~~~

社内にあるコンピューター（back）

~~~
ohno@back$ ssh guest@192.168.0.100 -p 20022
~~~

（概念図）


# Case2-2: インターネットに接続できる手元の携帯端末から、踏み台サーバーを経由して、手元のPCの上で動いているプレゼンツールを操作したい

（ネットワーク構成図）

http://rabbit-shocker.org/ja/rabbirack/

手元のPC：

~~~
$ ssh root@203.0.113.1 -i .ssh/conoha -R 203.0.113.1:20102:localhost:10102
~~~

手元の携帯端末

~~~
http://203.0.113.1:20102/
~~~

（概念図）


# Case2-3: 外部から到達不可能なネットワーク内にあるサーバに、踏み台サーバーを経由して、手元のPCからSSH接続したい

10.0.0.0/24のローカルネットワークにある
10.0.0.100のサーバー（ラベル：internal）へSSH接続する。
（新たにネットワークとサーバーを準備する）

（ネットワーク構成図）

internalから踏み台サーバーへSSH接続して、リモートフォワードを設定する。

~~~
user@internal$ ssh root@203.0.113.1 -i .ssh/conoha -R 20022:localhost:22
~~~

次に、手元のPCから踏み台サーバーへSSH接続する。
そうしたら、20022番ポートでSSH接続する。

~~~
$ ssh root@203.0.113.1 -i .ssh/conoha
root@front$ ssh localhost -p 20022
~~~

（概念図）



# Case3: ローカルフォワードとリモートフォワードの合わせ技

（概念図）

# Case3-1: 外部から到達不可能なネットワーク内にあるサーバに、踏み台サーバーを経由して、手元のPCからHTTP接続したい

（ネットワーク構成図）

まず、internalから踏み台サーバーへSSH接続して、リモートフォワードを設定する。

~~~
user@internal$ ssh root@203.0.113.1 -i .ssh/conoha -R 20080:localhost:80
~~~

次に、手元のPCから踏み台サーバーへSSH接続して、ローカルフォワードを設定する。

~~~
$ ssh root@203.0.113.1 -i .ssh/conoha -L 10080:localhost:20080
~~~

手元のPCの別のコンソール：

~~~
$ curl -L "http://localhost:10080/"
~~~

（概念図）

